<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GM Ritual On Base</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #ffffff, #b3e5fc);
  font-family: Arial, sans-serif;
  text-align: center;
}

button {
  padding: 14px;
  margin: 8px;
  width: 220px;
  border-radius: 10px;
  font-size: 18px;
  border: none;
  cursor: pointer;
}

#connectBtn {
  background-color: #2962ff;
  color: white;
}

.ritualBtn {
  background-color: #009688;
  color: white;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.min.js"></script>
</head>

<body>

<h1>GM Ritual â€¢ On Base</h1>
<h2>Connect â†’ Choose Ritual â†’ Confirm TX</h2>

<button id="connectBtn">Connect Wallet</button>
<br>
<button class="ritualBtn" id="gmBtn" disabled>GM Ritual âš¡</button>
<button class="ritualBtn" id="gnBtn" disabled>GN Ritual ðŸŒ™</button>
<button class="ritualBtn" id="sleepBtn" disabled>GoSleep Ritual ðŸ˜´</button>

<script>

const CONTRACT = "0x725Ccb4ddCB715f468b301395Dfd1b1efDb5308A";
const ABI = [
  "function performRitual(string calldata newMessage) external payable",
  "function fee() public view returns(uint256)"
];

let provider = null;
let signer = null;

/* âœ… Detect provider including OKX, Bitget, Metamask Mobile */
function getProvider() {
  if (window.ethereum) return window.ethereum;
  if (window.okxwallet) return window.okxwallet;
  if (window.bitkeep && window.bitkeep.ethereum) return window.bitkeep.ethereum;
  if (window.bitgetwallet) return window.bitgetwallet;
  return null;
}

/* âœ… Force Base network (8453) */
async function switchToBase(p) {
  try {
    await p.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: "0x2105" }]
    });
  } catch (err) {
    await p.request({
      method: "wallet_addEthereumChain",
      params: [{
        chainId: "0x2105",
        chainName: "Base",
        rpcUrls: ["https://mainnet.base.org"],
        nativeCurrency: { name: "Base ETH", symbol: "ETH", decimals: 18 },
        blockExplorerUrls: ["https://basescan.org"]
      }]
    });
  }
}

/* âœ… Connect wallet (mobile + desktop) */
async function connectWallet() {
  const p = getProvider();
  if (!p) {
    alert("Wallet not detected. Use Metamask/OKX/Bitget dApp browser.");
    return;
  }

  try {
    const accounts = await p.request({ method: "eth_requestAccounts" });

    await switchToBase(p);

    provider = new ethers.BrowserProvider(p);
    signer = await provider.getSigner();

    document.getElementById("connectBtn").innerText = "Connected âœ…";

    enableButtons();
  } catch (e) {
    console.error(e);
    alert("Connection failed âŒ");
  }
}

function enableButtons() {
  document.getElementById("gmBtn").disabled = false;
  document.getElementById("gnBtn").disabled = false;
  document.getElementById("sleepBtn").disabled = false;
}

/* âœ… Ritual Transaction */
async function perform(message) {
  try {
    const p = getProvider();
    await switchToBase(p);

    provider = new ethers.BrowserProvider(p);
    signer = await provider.getSigner();

    const c = new ethers.Contract(CONTRACT, ABI, signer);
    const fee = await c.fee();

    const tx = await c.performRitual(message, { value: fee });
    alert("Tx sentâ€¦");

    await tx.wait();
    alert("Ritual complete âœ…");

  } catch (err) {
    console.error(err);
    alert("TX failed âŒ");
  }
}

/* âœ… Button Actions */
document.getElementById("connectBtn").onclick = connectWallet;
document.getElementById("gmBtn").onclick = () => perform("GM âš¡");
document.getElementById("gnBtn").onclick = () => perform("GN ðŸŒ™");
document.getElementById("sleepBtn").onclick = () => perform("GoSleep ðŸ˜´");

</script>

</body>
  </html>
