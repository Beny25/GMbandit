<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GM Ritual On Base</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #ffffff, #b3e5fc);
  font-family: Arial, sans-serif;
  color: #000;
  text-align: center;
}
button {
  padding: 14px;
  margin: 8px;
  width: 220px;
  border-radius: 10px;
  font-size: 18px;
  border: none;
  cursor: pointer;
}
#connectBtn {
  background-color: #2962ff;
  color: white;
}
.ritualBtn {
  background-color: #009688;
  color: white;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.min.js"></script>
<script src="https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.umd.js"></script>
</head>

<body>

<h1>GM Ritual â€¢ On Base Chain</h1>
<h2>Connect â€¢ Select Ritual â€¢ Confirm Transaction</h2>

<button id="connectBtn">Connect Wallet</button>
<br>
<button class="ritualBtn" id="gmBtn" disabled>GM Ritual âœ…</button>
<button class="ritualBtn" id="gnBtn" disabled>GN Ritual ðŸŒ™</button>
<button class="ritualBtn" id="sleepBtn" disabled>GoSleep Ritual ðŸ˜´</button>

<script>
const CONTRACT_ADDRESS = "0x725Ccb4ddCB715f468b301395Dfd1b1efDb5308A";
const ABI = [
  "function performRitual(string calldata newMessage) external payable",
  "function fee() public view returns(uint256)"
];

// ===== WalletConnect Modal Setup =====
const wc = new window.WalletConnectModal.default({
  projectId: "6104d969b4ed13800dc8853d01b83d53",  // âœ… public project (aman buat testing)
  themeMode: "light",
  themeVariables: {
    "--wcm-font-family": "Arial"
  }
});

let provider = null;
let signer = null;

// ===== Auto-switch to Base chain =====
async function ensureBaseChain() {
  if (!window.ethereum) return;

  try {
    await window.ethereum.request({
       method: "wallet_switchEthereumChain",
       params: [{ chainId: "0x2105" }]
    });
  } catch (e) {
    await window.ethereum.request({
      method: "wallet_addEthereumChain",
      params: [{
        chainId: "0x2105",
        chainName: "Base",
        rpcUrls: ["https://mainnet.base.org"],
        nativeCurrency: { name: "Base", symbol: "ETH", decimals: 18 },
        blockExplorerUrls: ["https://basescan.org"],
      }]
    });
  }
}

async function connectWallet() {
  try {
    // ===== Coba Metamask/Browser Wallet =====
    if (window.ethereum) {
      await ensureBaseChain();
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      document.getElementById("connectBtn").innerText = "Connected âœ…";
      enableButtons();
      return;
    }

    // ===== Jika browser tidak punya injected wallet, fallback ke WalletConnect =====
    const session = await wc.openModal();
    if (session) {
      provider = new ethers.JsonRpcProvider("https://mainnet.base.org"); // fallback
      signer = null; // WC v2 tidak expose signer direct mode
      alert("WalletConnect connected â€” but direct signer not supported here.\nUse OKX dApp browser / MetaMask browser.");
      document.getElementById("connectBtn").innerText = "Connected (WC)";
      enableButtons();
    }

  } catch (err) {
    console.log(err);
    alert("Connection failed!");
  }
}

function enableButtons() {
  document.getElementById("gmBtn").disabled = false;
  document.getElementById("gnBtn").disabled = false;
  document.getElementById("sleepBtn").disabled = false;
}

// ========= ritual execution ==========
async function performRitual(messageText) {
  try {
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    await ensureBaseChain();

    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    const fee = await contract.fee();

    const tx = await contract.performRitual(messageText, {
      value: fee
    });

    alert("Tx sent! Waiting confirmation...");
    await tx.wait();
    alert("Ritual complete âœ…");
  } catch (err) {
    console.error(err);
    alert("Ritual failed âŒ");
  }
}


// ===== Button binds =====
document.getElementById("connectBtn").onclick = connectWallet;
document.getElementById("gmBtn").onclick = () => performRitual("GM âš¡");
document.getElementById("gnBtn").onclick = () => performRitual("GN ðŸŒ™");
document.getElementById("sleepBtn").onclick = () => performRitual("GoSleep ðŸ˜´");

</script>
<script>
document.addEventListener("DOMContentLoaded", async () => {

    let provider;
    let signer;
    let address;

    const connectButton = document.getElementById("connectWalletBtn");

    // âœ… fallback detect (mobile)
    async function detectProvider() {
        if (window.ethereum) return window.ethereum;
        if (window.okxwallet) return window.okxwallet;
        if (window.bitkeep) return window.bitkeep.ethereum;
        if (window.bitgetwallet) return window.bitgetwallet;
        return null;
    }

    connectButton.addEventListener("click", async () => {
        connectButton.disabled = true;

        try {
            provider = await detectProvider();
            if (!provider) {
                alert("No wallet detected ðŸ˜­ â€” please use OKX/Metamask/Bitget dApp browser");
                connectButton.disabled = false;
                return;
            }

            // âœ… request connect
            const accounts = await provider.request({ method: "eth_requestAccounts" });
            address = accounts[0];

            // âœ… if network = ETH â†’ switch to Base
            if (provider.networkVersion !== "8453") {
                try {
                    await provider.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: "0x2105" }],
                    });
                } catch (switchErr) {
                    // âœ… if chain missing â†’ add chain
                    await provider.request({
                        method: "wallet_addEthereumChain",
                        params: [{
                            chainId: "0x2105",
                            chainName: "Base",
                            rpcUrls: ["https://mainnet.base.org"],
                            nativeCurrency: { name: "Base Ether", symbol: "ETH", decimals: 18 },
                            blockExplorerUrls: ["https://basescan.org"]
                        }]
                    });
                }
            }

            connectButton.innerText = "Connected âœ…";
            connectButton.style.background = "#4CAF50";

        } catch (err) {
            console.warn(err);
            connectButton.disabled = false;
        }
    });

});
</script>
  
</body>
</html>
