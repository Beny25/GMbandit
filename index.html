<script type="module">
  import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.min.js";

  let provider = null;
  let signer = null;
  let connectedAddress = null;

  const connectBtn = document.getElementById("connectBtn");
  const walletMenu = document.getElementById("walletMenu");
  const walletAddr = document.getElementById("walletAddr");
  const disconnectBtn = document.getElementById("disconnectBtn");
  const statusBox = document.getElementById("status");

  const contractAddress = "0x725Ccb4ddCB715f468b301395Dfd1b1efDb5308A";

  const abi = [
    "function performRitual(string newMessage) payable",
    "function fee() view returns (uint256)"
  ];

  function shortAddr(addr) {
    return addr.slice(0,6) + "..." + addr.slice(-4);
  }

  function updateUI() {
    if (!connectedAddress) {
      connectBtn.innerText = "Connect Wallet";
      walletMenu.style.display = "none";
    } else {
      connectBtn.innerText = "âœ… " + shortAddr(connectedAddress);
      walletAddr.innerText = connectedAddress;
      walletMenu.style.display = "block";
    }
  }

  connectBtn.onclick = async function () {
    if (!window.ethereum) return alert("Install MetaMask or BaseWallet!");

    try {
      provider = new ethers.BrowserProvider(window.ethereum);
      const accounts = await ethereum.request({ method: "eth_requestAccounts" });
      signer = await provider.getSigner();
      connectedAddress = accounts[0];

      statusBox.innerText = "ğŸ”— Connected!";
      updateUI();
    } catch (err) {
      console.error(err);
      alert("Wallet connection failed");
    }
  };

  disconnectBtn.onclick = function () {
    provider = null;
    signer = null;
    connectedAddress = null;
    statusBox.innerText = "ğŸ”Œ Disconnected";

    updateUI();
  };

  if (window.ethereum) {
    window.ethereum.on("accountsChanged", async (accounts) => {
      if (accounts.length === 0) {
        connectedAddress = null;
        signer = null;
        provider = null;
        statusBox.innerText = "ğŸ”Œ Wallet disconnected";
      } else {
        connectedAddress = accounts[0];
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        statusBox.innerText = "ğŸ”— Connected!";
      }
      updateUI();
    });
  }

  window.ritual = async function (msg) {
    if (!signer) return alert("Connect wallet first!");

    const contract = new ethers.Contract(contractAddress, abi, signer);
    const fee = await contract.fee();

    try {
      statusBox.innerText = "â³ Sending ritual...";
      const tx = await contract.performRitual(msg, { value: fee });
      await tx.wait();
      statusBox.innerText = "âœ… Ritual sent: " + msg;
    } catch (err) {
      console.log(err);
      statusBox.innerText = "âŒ Ritual failed";
    }
  };
</script>
