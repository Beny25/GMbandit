<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GM Ritual Dashboard üî•</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: linear-gradient(to bottom, #ffffff, #e3f0ff);
        font-family: Arial, sans-serif;
        text-align: center;
    }

    h1 {
        margin-top: 50px;
        font-size: 32px;
        color: #004aad;
        font-weight: 700;
    }

    #walletBox {
        position: absolute;
        top: 20px;
        right: 20px;
    }

    #connectBtn {
        background: #0066ff;
        color: white;
        border: none;
        padding: 12px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
    }

    #connectBtn:hover {
        background: #004bd1;
    }

    #walletMenu {
        display: none;
        position: absolute;
        top: 60px;
        right: 0;
        width: 200px;
        background: #ffffff;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    #walletAddr {
        font-size: 15px;
        margin: 10px 0;
    }

    #disconnectBtn {
        background: #ff4b4b;
        color: white;
        width: 100%;
        border: none;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
        font-weight: 600;
    }

    .ritualBtn {
        padding: 12px 26px;
        margin: 15px;
        font-size: 18px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        color: white;
    }

    .gm { background: #007bff; }
    .gm:hover { background: #0066d6; }

    .gn { background: #7b2bff; }
    .gn:hover { background: #6622d1; }

    .sleep { background: #2c2c2c; }
    .sleep:hover { background: #000000; }

    #status {
        margin-top: 40px;
        font-size: 20px;
        font-weight: 600;
        color: #333;
    }

</style>
</head>
<body>

<h1>GM Ritual Dashboard ‚ö°</h1>

<div id="walletBox">
    <button id="connectBtn">Connect Wallet</button>
    <div id="walletMenu">
        <div id="walletAddr">0x0000...</div>
        <button id="disconnectBtn">Disconnect</button>
    </div>
</div>

<div style="margin-top: 90px;">
    <button class="ritualBtn gm" onclick="deploy()">Deploy Ritual üîÆ</button>
</div>

<div style="margin-top: 40px;">
    <button class="ritualBtn gm" onclick="ritual('GM')">GM Ritual üöÄ</button>
    <button class="ritualBtn gn" onclick="ritual('GN')">GN Ritual üåô</button>
    <button class="ritualBtn sleep" onclick="ritual('GoSleep')">GoSleep Ritual üò¥</button>
</div>

<div id="status"></div>

<script type="module">
import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.min.js";

const factoryAddress = "0xb9C0b964E223D0058cdFEB445B4506415117b055";

const factoryABI = [
  "function deployContract(address owner,address creator,address collector) returns(address)",
  "event ContractDeployed(address newContract)"
];

const ritualABI = [
  "function performRitual(string newMessage) payable",
  "function fee() view returns (uint256)"
];

let provider = null;
let signer = null;
let connectedAddress = null;
let activeContract = null;

const connectBtn = document.getElementById("connectBtn");
const walletMenu = document.getElementById("walletMenu");
const walletAddr = document.getElementById("walletAddr");
const disconnectBtn = document.getElementById("disconnectBtn");
const statusBox = document.getElementById("status");

function shortAddr(addr) {
  return addr.slice(0, 6) + "..." + addr.slice(-4);
}

function updateUI() {
  if (!connectedAddress) {
    connectBtn.innerText = "Connect Wallet";
    walletMenu.style.display = "none";
  } else {
    connectBtn.innerText = "‚úÖ " + shortAddr(connectedAddress);
    walletMenu.style.display = "block";
    walletAddr.innerText = shortAddr(connectedAddress);
  }
}

connectBtn.onclick = async function () {
  try {
    if (!window.ethereum) return alert("Install MetaMask or Base Wallet.");
    provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    signer = await provider.getSigner();
    connectedAddress = accounts[0];
    updateUI();
  } catch (err) {
    alert("Failed to connect wallet");
  }
};

disconnectBtn.onclick = function () {
  provider = null;
  signer = null;
  connectedAddress = null;
  activeContract = null;
  statusBox.innerText = "";
  updateUI();
};

window.deploy = async function () {
  if (!signer) return alert("Connect wallet first!");

  const factory = new ethers.Contract(factoryAddress, factoryABI, signer);

  try {
    statusBox.innerText = "‚è≥ Deploying new ritual contract...";
    const tx = await factory.deployContract(
      connectedAddress,
      connectedAddress,
      connectedAddress
    );
    const receipt = await tx.wait();

    const event = receipt.logs.find(
      log => log.fragment && log.fragment.name === "ContractDeployed"
    );
    const newAddress = event.args.newContract;

    activeContract = new ethers.Contract(newAddress, ritualABI, signer);
    statusBox.innerText = "‚úÖ Deployed new contract: " + newAddress;
  } catch (err) {
    statusBox.innerText = "‚ùå Deploy Failed";
  }
};

window.ritual = async function (msg) {
  if (!activeContract) return alert("Deploy contract dulu!");

  try {
    const fee = await activeContract.fee();
    statusBox.innerText = "‚è≥ Sending ritual...";
    const tx = await activeContract.performRitual(msg, { value: fee });
    await tx.wait();
    statusBox.innerText = "‚úÖ Ritual Sent: " + msg;
  } catch (err) {
    statusBox.innerText = "‚ùå Ritual Failed";
  }
};

</script>

</body>
</html>
