<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GM Ritual â€¢ On Base</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --card:#161a22; --text:#e9eefb; --muted:#9aa4b2;
      --blue:#2563eb; --purple:#7c3aed; --green:#16a34a; --red:#ef4444;
    }
    body{
      margin:0;background:linear-gradient(180deg,#0e1117,#0b1220 60%);
      color:var(--text);font-family:Arial,system-ui;text-align:center;
    }
    .wrap{max-width:880px;margin:48px auto;padding:0 16px;}
    .card{background:#161a22;border-radius:16px;padding:22px;border:1px solid #1e2531;}
    button{padding:14px 18px;border-radius:12px;font-size:16px;font-weight:600;
      cursor:pointer;border:0;transition:.15s;}
    .btn{min-width:220px;margin:6px;}
    .primary{background:var(--blue);color:white;}
    .danger{background:var(--red);color:white;}
    .gm{background:#1d4ed8;color:white;}
    .gn{background:#6d28d9;color:white;}
    .sleep{background:#475569;color:#e2e8f0;}
    .disabled{opacity:.45;pointer-events:none;}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;
      background:#0b1324;border-radius:12px;border:1px solid #1f2d44;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>

<body>
<div class="wrap">
  <h1>GM Ritual Dashboard âš¡</h1>
  <p style="color:#9aa4b2">1 ritual per day â€¢ resets at 00:00 UTC</p>

  <div class="card">
    <button id="connectBtn" class="btn primary">Connect Wallet</button>
    <button id="disconnectBtn" class="btn danger disabled">Disconnect</button>

    <div id="userBar" style="margin:15px 0;display:none;">
      <span class="chip" id="addrChip">0x0000â€¦0000</span>
    </div>

    <button id="gmBtn" class="btn gm disabled">GM Ritual âš¡</button>
    <button id="gnBtn" class="btn gn disabled">GN Ritual ðŸŒ™</button>
    <button id="sleepBtn" class="btn sleep disabled">GoSleep ðŸ˜´</button>
  </div>
</div>

<script>
(() => {

  const CONTRACT = "0x725Ccb4ddCB715f468b301395Dfd1b1efDb5308A";
  const ABI = [
    "function performRitual(string calldata newMessage) external payable",
    "function fee() view returns(uint256)"
  ];
  const BASE_CHAIN = "0x2105";

  let provider, signer, account;

  const $ = (i) => document.getElementById(i);
  const connectBtn = $("connectBtn");
  const disconnectBtn = $("disconnectBtn");
  const gmBtn = $("gmBtn");
  const gnBtn = $("gnBtn");
  const sleepBtn = $("sleepBtn");
  const userBar = $("userBar");
  const addrChip = $("addrChip");

  function short(addr){ return addr.slice(0,6)+"â€¦"+addr.slice(-4); }

  function disableAllButtons(val){
    gmBtn.classList.toggle("disabled", val);
    gnBtn.classList.toggle("disabled", val);
    sleepBtn.classList.toggle("disabled", val);
  }

  function updateUIConnected(){
    connectBtn.classList.add("disabled");
    disconnectBtn.classList.remove("disabled");
    userBar.style.display = "block";
    addrChip.textContent = short(account);

    checkCooldown() ? disableAllButtons(true) : disableAllButtons(false);
  }

  function updateUIDisconnected(){
    connectBtn.classList.remove("disabled");
    disconnectBtn.classList.add("disabled");
    userBar.style.display = "none";
    disableAllButtons(true);
  }

  async function ensureBase(){
    const eth = window.ethereum;
    const cid = await eth.request({method:"eth_chainId"});
    if (cid === BASE_CHAIN) return;
    try {
      await eth.request({ method:"wallet_switchEthereumChain", params:[{chainId:BASE_CHAIN}] });
    } catch(e){
      if (e.code === 4902){
        await eth.request({
          method:"wallet_addEthereumChain",
          params:[{
            chainId:BASE_CHAIN,
            chainName:"Base",
            rpcUrls:["https://mainnet.base.org"],
            nativeCurrency:{name:"Base Ether",symbol:"ETH",decimals:18},
            blockExplorerUrls:["https://basescan.org"]
          }]
        });
      } else throw e;
    }
  }

  async function connect(){
    try{
      const eth = window.ethereum || window.okxwallet || (window.bitkeep && window.bitkeep.ethereum);
      if (!eth){ alert("Wallet not detected"); return; }

      await ensureBase();

      provider = new ethers.providers.Web3Provider(eth,"any");
      await provider.send("eth_requestAccounts",[]);
      signer = provider.getSigner();
      account = await signer.getAddress();

      updateUIConnected();

      eth.on("accountsChanged", (acc)=>{
        if (!acc.length){ disconnect(); return; }
        account = acc[0]; addrChip.textContent = short(account);
        updateUIConnected();
      });

      eth.on("chainChanged",(cid)=>{
        if (cid !== BASE_CHAIN) disconnect();
      });

    }catch(e){
      console.error(e);
      alert("Connection failed");
      updateUIDisconnected();
    }
  }

  function disconnect(){
    provider = null; signer = null; account = null;
    updateUIDisconnected();
  }

  function cooldownKey(){ return "ritual_"+account; }

  function checkCooldown(){
    if (!account) return true;
    const saved = localStorage.getItem(cooldownKey());
    if (!saved) return false;
    const today = new Date().toISOString().slice(0,10);
    return saved === today;
  }

  function markCooldown(){
    const today = new Date().toISOString().slice(0,10);
    localStorage.setItem(cooldownKey(), today);
  }

  async function ritual(msg){
    if (checkCooldown()){
      alert("Already did ritual today âœ…");
      return;
    }
    try{
      await ensureBase();
      const c = new ethers.Contract(CONTRACT, ABI, signer);
      const fee = await c.fee();

      const tx = await c.performRitual(msg, { value: fee });
      alert("Waiting confirmationâ€¦");
      await tx.wait();

      markCooldown();
      disableAllButtons(true);
      alert("Ritual completed âœ…");

    }catch(err){
      console.error(err);
      alert("Ritual failed âŒ");
    }
  }

  connectBtn.onclick = connect;
  disconnectBtn.onclick = disconnect;
  gmBtn.onclick = () => ritual("GM âš¡");
  gnBtn.onclick = () => ritual("GN ðŸŒ™");
  sleepBtn.onclick = () => ritual("GoSleep ðŸ˜´");

  updateUIDisconnected();

})();
</script>

</body>
</html>
