<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GM Ritual â€¢ On Base</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #ffffff, #b3e5fc);
  font-family: Arial, sans-serif;
  color: #000;
  text-align: center;
}
button {
  padding: 14px;
  margin: 10px;
  width: 230px;
  border-radius: 12px;
  font-size: 18px;
  border: none;
  cursor: pointer;
}
#connectBtn {
  background: #2962ff;
  color: white;
}
.ritualBtn {
  background: #009688;
  color: white;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.min.js"></script>

</head>
<body>

<h1>GM Ritual â€¢ On Base</h1>
<h2>Connect â†’ Choose Ritual â†’ Confirm TX</h2>

<button id="connectBtn">Connect Wallet</button>
<br>
<button class="ritualBtn" id="gmBtn" disabled>GM Ritual âš¡</button>
<button class="ritualBtn" id="gnBtn" disabled>GN Ritual ðŸŒ™</button>
<button class="ritualBtn" id="sleepBtn" disabled>GoSleep Ritual ðŸ˜´</button>

<script>
const CONTRACT_ADDRESS = "0x725Ccb4ddCB715f468b301395Dfd1b1efDb5308A";
const ABI = [
  "function performRitual(string calldata newMessage) external payable",
  "function fee() public view returns(uint256)"
];

let provider = null;
let signer = null;

// âœ… detect multi-wallet provider
function detectProvider() {
  if (window.ethereum) return window.ethereum;
  if (window.okxwallet) return window.okxwallet;
  if (window.bitget && window.bitget.ethereum) return window.bitget.ethereum;
  if (window.bitkeep && window.bitkeep.ethereum) return window.bitkeep.ethereum;
  return null;
}

// âœ… ensure Base chain
async function ensureBaseChain(injected) {
  try {
    await injected.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: "0x2105" }]
    });
  } catch (err) {
    await injected.request({
      method: "wallet_addEthereumChain",
      params: [{
        chainId: "0x2105",
        chainName: "Base",
        rpcUrls: ["https://mainnet.base.org"],
        nativeCurrency: { name: "Base Ether", symbol: "ETH", decimals: 18 },
        blockExplorerUrls: ["https://basescan.org"]
      }]
    });
  }
}

// âœ… connect wallet
async function connectWallet() {
  try {
    const injected = detectProvider();
    if (!injected) {
      alert("âŒ Wallet not detected â€” open in OKX/Bitget/Metamask dApp browser.");
      return;
    }

    const accounts = await injected.request({ method: "eth_requestAccounts" });

    await ensureBaseChain(injected);

    provider = new ethers.BrowserProvider(injected);
    signer = await provider.getSigner();

    document.getElementById("connectBtn").innerText = accounts[0].slice(0, 6) + "..." + accounts[0].slice(-4);
    document.getElementById("connectBtn").style.background = "#4CAF50";

    enableButtons();
  } catch (err) {
    console.error(err);
    alert("Connection failed âŒ");
  }
}

function enableButtons() {
  document.getElementById("gmBtn").disabled = false;
  document.getElementById("gnBtn").disabled = false;
  document.getElementById("sleepBtn").disabled = false;
}

// âœ… execute ritual with real transaction
async function performRitual(msg) {
  try {
    const injected = detectProvider();
    if (!injected) {
      alert("Wallet not detected ðŸ˜­");
      return;
    }

    provider = new ethers.BrowserProvider(injected);
    signer = await provider.getSigner();

    await ensureBaseChain(injected);

    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    const fee = await contract.fee();

    const tx = await contract.performRitual(msg, { value: fee });

    alert("Transaction sent âœ…\nWaiting confirmation...");
    await tx.wait();
    alert("Ritual Complete âœ…");
  } catch (err) {
    console.log(err);
    alert("Ritual Failed âŒ");
  }
}

// âœ… bind buttons
document.getElementById("connectBtn").onclick = connectWallet;
document.getElementById("gmBtn").onclick = () => performRitual("GM âš¡");
document.getElementById("gnBtn").onclick = () => performRitual("GN ðŸŒ™");
document.getElementById("sleepBtn").onclick = () => performRitual("GoSleep ðŸ˜´");
</script>

</body>
</html>
