<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GM Ritual â€¢ On Base</title>

<style>
body {
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #ffffff, #b3e5fc);
  font-family: Arial, sans-serif;
  text-align: center;
}
button {
  padding: 14px;
  margin: 8px;
  width: 250px;
  border-radius: 10px;
  font-size: 18px;
  border: none;
  cursor: pointer;
}
#connectBtn {
  background: #2962ff;
  color: white;
}
.ritualBtn {
  background: #009688;
  color: white;
}
.ritualBtn:disabled {
  background: #bdbdbd;
  color: #666;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.min.js"></script>
</head>

<body>

<h1>GM Ritual â€¢ Base Chain</h1>
<p>Daily ritual cooldown reset at 00:00 UTC</p>

<button id="connectBtn">Connect Wallet</button>
<br>
<button class="ritualBtn" id="gmBtn" disabled>GM Ritual âš¡</button>
<button class="ritualBtn" id="gnBtn" disabled>GN Ritual ðŸŒ™</button>
<button class="ritualBtn" id="sleepBtn" disabled>GoSleep ðŸ˜´</button>

<script>
const CONTRACT_ADDRESS = "0x725Ccb4ddCB715f468b301395Dfd1b1efDb5308A";
const ABI = [
  "function performRitual(string calldata newMessage) external payable",
  "function fee() public view returns(uint256)"
];

let provider = null;
let signer = null;
let userAddress = null;

// âœ… Check if user has already done ritual today
function alreadyDidRitualToday() {
  if (!userAddress) return false;
  const key = "ritualDate_" + userAddress;
  const saved = localStorage.getItem(key);
  const todayUTC = new Date().toISOString().slice(0, 10);  
  return saved === todayUTC;
}

// âœ… Mark ritual done today
function markRitualDone() {
  const key = "ritualDate_" + userAddress;
  const todayUTC = new Date().toISOString().slice(0, 10);
  localStorage.setItem(key, todayUTC);
}

// âœ… Update button state
function updateButtons() {
  const disabled = alreadyDidRitualToday();
  document.getElementById("gmBtn").disabled = disabled;
  document.getElementById("gnBtn").disabled = disabled;
  document.getElementById("sleepBtn").disabled = disabled;
}

// âœ… Auto-switch or add Base chain
async function ensureBase() {
  if (!window.ethereum) return;
  try {
    await window.ethereum.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: "0x2105" }]
    });
  } catch (err) {
    try {
      await window.ethereum.request({
        method: "wallet_addEthereumChain",
        params: [{
          chainId: "0x2105",
          chainName: "Base",
          rpcUrls: ["https://mainnet.base.org"],
          nativeCurrency: { name: "Base", symbol: "ETH", decimals: 18 },
          blockExplorerUrls: ["https://basescan.org"]
        }]
      });
    } catch (e) {}
  }
}

// âœ… Connect wallet
async function connectWallet() {
  if (!window.ethereum) {
    alert("No Web3 wallet detected. Use OKX/Bitget/MetaMask dApp browser.");
    return;
  }

  try {
    await ensureBase();

    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    document.getElementById("connectBtn").innerText = "Connected âœ…";

    updateButtons();

  } catch (err) {
    alert("Connection failed.");
  }
}

// âœ… Ritual execution
async function performRitual(message) {
  if (alreadyDidRitualToday()) {
    alert("You've already performed today's ritual âœ… Come back tomorrow.");
    return;
  }

  try {
    await ensureBase();

    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();

    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    const fee = await contract.fee();

    const tx = await contract.performRitual(message, { value: fee });
    alert("Transaction submitted...");
    await tx.wait();

    markRitualDone();  // âœ… Save ritual day
    updateButtons();   // âœ… Disable buttons

    alert("Ritual complete âœ…");

  } catch (err) {
    console.error(err);
    alert("Ritual failed âŒ");
  }
}

// âœ… Bind buttons
document.getElementById("connectBtn").onclick = connectWallet;
document.getElementById("gmBtn").onclick = () => performRitual("GM âš¡");
document.getElementById("gnBtn").onclick = () => performRitual("GN ðŸŒ™");
document.getElementById("sleepBtn").onclick = () => performRitual("GoSleep ðŸ˜´");

</script>

</body>
</html>
